/*!
* \ntuaneChart.js
* http://antuane.com/
* Version: 1.0.0
*
* Copyright 2015 Di√≥genes Silveira
* Released under the MIT license
* https://github.com/antuane/
*/
"use strict";function AntuaneChart(t){this.init(t)}AntuaneChart.prototype.helper={getRandomInt:function(t,n){return Math.floor(Math.random()*(n-t))+t},roundRect:function(t,n,o,i,e,a,r){t.beginPath(),t.moveTo(n+a,o),t.lineTo(n+i-a,o),t.quadraticCurveTo(n+i,o,n+i,o+a),t.lineTo(n+i,o+e-a),t.quadraticCurveTo(n+i,o+e,n+i-a,o+e),t.lineTo(n+a,o+e),t.quadraticCurveTo(n,o+e,n,o+e-a),t.lineTo(n,o+a),t.quadraticCurveTo(n,o,n+a,o),t.closePath(),t.stroke(),r||t.fill()},wrapText:function(t,n,o,i,e,a,r){t.textAlign="center",t.textBaseline="middle",o+=e/2,i+=a/2;for(var c=n.split("\n"),g=0;g<c.length;g++){for(var f="",l=c[g].split(" "),h=0;h<l.length;h++){var s=f+l[h]+" ",d=t.measureText(s),m=d.width;m>e?(f=l[h]+" ",i-=r/2):f=s}f="";for(var h=0;h<l.length;h++){var s=f+l[h]+" ",d=t.measureText(s),m=d.width;m>e?(t.fillText(f,o,i),f=l[h]+" ",i+=r):f=s}t.fillText(f,o,i),i+=r}},colorLuminance:function(t,n){t=String(t).replace(/[^0-9a-f]/gi,""),t.length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]),n=n||0;var o,i,e="#";for(i=0;3>i;i++)o=parseInt(t.substr(2*i,2),16),o=Math.round(Math.min(Math.max(0,o+o*n),255)).toString(16),e+=("00"+o).substr(o.length);return e},cloneObj:function(t){if(null==t||"object"!=typeof t)return t;var n=t.constructor();for(var o in t)t.hasOwnProperty(o)&&(n[o]=cloneObj(t[o]));return n},getObjById:function(t,n){for(var o=0;o<t.length;o++)if(t[o].id==n)return t[o];return null},trackTransforms:function(t){var n=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=n.createSVGMatrix();t.getTransform=function(){return o};var i=[],e=t.save;t.save=function(){return i.push(o.translate(0,0)),e.call(t)};var a=t.restore;t.restore=function(){return o=i.pop(),a.call(t)};var r=t.scale;t.scale=function(n,i){return o=o.scaleNonUniform(n,i),r.call(t,n,i)};var c=t.rotate;t.rotate=function(n){return o=o.rotate(180*n/Math.PI),c.call(t,n)};var g=t.translate;t.translate=function(n,i){return o=o.translate(n,i),g.call(t,n,i)};var f=t.transform;t.transform=function(i,e,a,r,c,g){var l=n.createSVGMatrix();return l.a=i,l.b=e,l.c=a,l.d=r,l.e=c,l.f=g,o=o.multiply(l),f.call(t,i,e,a,r,c,g)};var l=t.setTransform;t.setTransform=function(n,i,e,a,r,c){return o.a=n,o.b=i,o.c=e,o.d=a,o.e=r,o.f=c,l.call(t,n,i,e,a,r,c)};var h=n.createSVGPoint();t.transformedPoint=function(t,n){return h.x=t,h.y=n,h.matrixTransform(o.inverse())}}},AntuaneChart.prototype.init=function(t){var n=this;if(n.canvas=document.getElementById(t.config.element),!n.canvas)throw"Element not found";n.context=n.canvas.getContext("2d"),n.context=this.canvas.getContext("2d"),n.context.lineWidth=t.config.lineWidth,t.config.autoSize&&(this.canvas.width=this.canvas.parentNode.clientWidth,this.canvas.height=this.canvas.parentNode.clientHeight),n.helper.trackTransforms(this.context),t.config.scaleFactor=1.1,t.config.zoomScale=0,t.config.moveX=0,t.config.moveY=0,this.config=t.config,this.update(t),this.draw(),n.config.mouseEvents&&this.events()},AntuaneChart.prototype.addZoom=function(t){var n=this;n.config.zoomScale+=t;var o=n.context.transformedPoint(n.canvas.width/2,n.canvas.height/2);this.context.translate(o.x,o.y);var i=Math.pow(n.config.scaleFactor,t);n.context.scale(i,i),n.context.translate(-o.x,-o.y),this.draw()},AntuaneChart.prototype.resetZoom=function(){var t=this;t.addZoom(-t.config.zoomScale),t.context.translate(-t.config.moveX,-t.config.moveY),t.config.zoomScale=0,t.config.moveX=0,t.config.moveY=0},AntuaneChart.prototype.events=function(){var t=this,n=t.canvas.width/2,o=t.canvas.height/2,i=!1,e=!1;t.canvas.addEventListener("mousedown",function(a){document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",t.canvas.style.cursor="move",n=a.offsetX||a.pageX-t.canvas.offsetLeft,o=a.offsetY||a.pageY-t.canvas.offsetTop,i=t.context.transformedPoint(n,o),e=!1,a.returnValue=!1},!1),t.canvas.addEventListener("mousemove",function(a){if(n=a.offsetX||a.pageX-t.canvas.offsetLeft,o=a.offsetY||a.pageY-t.canvas.offsetTop,e=!0,i){var r=t.context.transformedPoint(n,o);t.context.translate(r.x-i.x,r.y-i.y),t.draw(),t.config.moveX+=r.x-i.x,t.config.moveY+=r.y-i.y}},!1),t.canvas.addEventListener("mouseup",function(n){i=null,t.canvas.style.cursor="default"},!1);var a=function(n){var o=n.wheelDelta?n.wheelDelta/300:n.detail?-n.detail:0;return t.addZoom(o),n.preventDefault()&&!1};t.canvas.addEventListener("DOMMouseScroll",a,!1),t.canvas.addEventListener("mousewheel",a,!1)},AntuaneChart.prototype.update=function(t){for(var n=this,o=[],i=[],e=0,a=0,r=0;r<t.diagrams.length;r++){for(var c={id:t.diagrams[r].id,x:0,y:0,cx:0,cy:0,text:t.diagrams[r].text,color:t.diagrams[r].color,bgColor:t.diagrams[r].bgColor,parents:[],children:[],virgin:!0,orphan:!0},g=0;g<t.links.length;g++)t.links[g].source==c.id&&(c.parents.push(t.links[g].parent),c.orphan=!1),t.links[g].parent==c.id&&(c.children.push(t.links[g].source),c.orphan=!1);o.push(c)}for(var f=function h(t,i){if(t.virgin){t.virgin=!1,t.y=i,a>i&&(a=i);for(var e=0;e<t.children.length;e++){var r=n.helper.getObjById(o,t.children[e]);h(r,i+1)}for(var e=0;e<t.parents.length;e++){var r=n.helper.getObjById(o,t.parents[e]);h(r,i-1)}}},r=0;r<o.length;r++)f(o[r],0);for(var r=0;r<o.length;r++){var l=n.helper.getObjById(i,o[r].y);null!=l?o[r].orphan||(l.count++,o[r].x=l.count,l.count>e&&(e=l.count)):o[r].orphan||(i.push({id:o[r].y,count:1}),o[r].x=1)}this.config.linesCount=i,this.config.columnsCount=e,this.config.columnLower=a,this.diagrams=o},AntuaneChart.prototype.draw=function(){var t=this;if(t.context.transformedPoint){var n=t.context.transformedPoint(0,0),o=t.context.transformedPoint(t.canvas.width,t.canvas.height);t.context.clearRect(n.x,n.y,o.x-n.x,o.y-n.y)}else t.context.clearRect(0,0,t.canvas.width,t.canvas.height);var i=t.config.width+2*t.config.margin;0==t.config.columnsCount&&(t.config.columnsCount=parseInt(t.canvas.width/i));var e=t.config.columnsCount*i,a=parseInt(t.canvas.width)/2-e/2;t.context.rotate(2*Math.PI);for(var r=0,c=0;c<t.diagrams.length;c++)if(t.diagrams[c].orphan){var g=a+t.config.margin+parseInt(r%t.config.columnsCount)*(t.config.width+2*t.config.margin),f=t.config.margin+parseInt(r/t.config.columnsCount)*(t.config.height+2*t.config.margin);t.context.fillStyle=t.diagrams[c].bgColor,t.context.strokeStyle=t.diagrams[c].bgColor,t.helper.roundRect(t.context,g,f,t.config.width,t.config.height,t.config.radius,t.config.hiddenBg);var l=t.context;l.fillStyle=t.diagrams[c].color,l.font=t.config.fontSize+"px "+t.config.fontFamily,t.helper.wrapText(t.context,t.diagrams[c].text,g+t.config.padding,f,t.config.width-2*t.config.padding,t.config.height,t.config.fontSize+.2*t.config.fontSize),r++}var h=t.config.height+3*t.config.margin+parseInt((r-1)/t.config.columnsCount)*(t.config.height+2*t.config.margin);isNaN(h)&&(h=t.config.margin);for(var c=0;c<t.diagrams.length;c++)if(!t.diagrams[c].orphan){var s=t.helper.getObjById(t.config.linesCount,t.diagrams[c].y).count,d=e/s,g=a+d*t.diagrams[c].x+(d/2-t.config.width/2)-d,f=h+Math.abs(t.config.columnLower)*(t.config.height+2*t.config.margin)+t.diagrams[c].y*(t.config.height+2*t.config.margin);t.diagrams[c].left=g,t.diagrams[c].top=f}for(var c=0;c<t.diagrams.length;c++)if(!t.diagrams[c].orphan)for(var m=0;m<t.diagrams[c].parents.length;m++){var u=t.helper.getObjById(t.diagrams,t.diagrams[c].parents[m]),x=!1,v=!1,p=!1,w=0,y=0;t.diagrams[c].id==u.id?p=!0:t.diagrams[c].y<u.y?x=!0:t.diagrams[c].y-u.y>1&&(v=!0),t.context.setLineDash&&t.context.setLineDash([t.config.lineWidth,0]),t.context.strokeStyle=t.config.lineColor||t.diagrams[c].bgColor,t.context.fillStyle=t.config.lineColor||t.diagrams[c].bgColor,x&&(t.context.strokeStyle="#ff0000",t.context.fillStyle="#ff0000");var T=0;p?(T=t.config.margin/2-t.config.margin/t.config.columnsCount*t.diagrams[c].x,isFinite(T)||(T=0),t.context.beginPath(),t.context.moveTo(u.left+t.config.width/2+-1*T-T,u.top+t.config.height),t.context.lineTo(u.left+t.config.width/2+-1*T-T,u.top+t.config.height+t.config.margin/2.5),t.context.lineTo(u.left+t.config.width/2+-1*T+T,u.top+t.config.height+t.config.margin/2.5),t.context.lineTo(u.left+t.config.width/2+-1*T+T,u.top+t.config.height+t.config.arrowWidth/2),t.context.stroke(),t.context.beginPath(),t.context.moveTo(u.left+t.config.width/2+-1*T+T,u.top+t.config.height),t.context.lineTo(u.left+t.config.width/2-t.config.arrowWidth/2+-1*T+T,u.top+t.config.height+t.config.arrowWidth),t.context.lineTo(u.left+t.config.width/2+t.config.arrowWidth/2+-1*T+T,u.top+t.config.height+t.config.arrowWidth),t.context.fill()):x?(t.config.lineDiff&&(T=t.config.margin/2-t.config.margin/t.config.columnsCount*t.diagrams[c].x+(t.config.margin-(t.config.arrowWidth+2*t.config.lineWidth*y))),t.context.setLineDash&&t.context.setLineDash([t.config.lineWidth,t.config.lineWidth]),t.context.beginPath(),t.context.moveTo(t.diagrams[c].left+t.config.width/2+T,t.diagrams[c].top+0*t.config.height/2+T),t.context.lineTo(t.diagrams[c].left+t.config.width+t.config.margin+T,t.diagrams[c].top+0*t.config.height/2+T),t.context.lineTo(t.diagrams[c].left+t.config.width+t.config.margin+T,u.top-2*t.config.margin+T),t.context.lineTo(u.left+t.config.width/2+T,u.top-2*t.config.margin+T),t.context.lineTo(u.left+t.config.width/2+T,u.top-t.config.arrowWidth+T),t.context.lineWidth=t.config.lineWidth,t.context.stroke(),t.context.beginPath(),t.context.moveTo(u.left+t.config.width/2+T,u.top),t.context.lineTo(u.left+t.config.width/2-t.config.arrowWidth/2+T,u.top-t.config.arrowWidth),t.context.lineTo(u.left+t.config.width/2+t.config.arrowWidth/2+T,u.top-t.config.arrowWidth),t.context.fill()):v?(t.config.lineDiff&&(T=t.config.margin/2-t.config.margin/t.config.columnsCount*t.diagrams[c].x+(t.config.margin-(t.config.arrowWidth+2*t.config.lineWidth*w))),w++,isFinite(T)||(T=0),t.context.setLineDash&&t.context.setLineDash([t.config.lineWidth,t.config.lineWidth]),t.context.beginPath(),t.context.moveTo(t.diagrams[c].left+t.config.width/2+-1*T,t.diagrams[c].top),t.context.lineTo(t.diagrams[c].left+t.config.width/2+-1*T,t.diagrams[c].top-t.config.margin+T),t.context.lineTo(u.left+t.config.width/2+-1*T,t.diagrams[c].top-t.config.margin+T),t.context.lineTo(u.left+t.config.width/2+-1*T,u.top+t.config.height+t.config.margin+T),t.context.lineTo(u.left+t.config.width/2+-1*T,u.top+t.config.height+t.config.arrowWidth/2),t.context.lineWidth=t.config.lineWidth,t.context.stroke(),t.context.beginPath(),t.context.moveTo(u.left+t.config.width/2+-1*T,u.top+t.config.height),t.context.lineTo(u.left+t.config.width/2-t.config.arrowWidth/2+-1*T,u.top+t.config.height+t.config.arrowWidth),t.context.lineTo(u.left+t.config.width/2+t.config.arrowWidth/2+-1*T,u.top+t.config.height+t.config.arrowWidth),t.context.fill()):(t.config.lineDiff&&(T=t.config.margin/2-t.config.margin/t.config.columnsCount*t.diagrams[c].x),isFinite(T)||(T=0),t.context.beginPath(),t.context.moveTo(t.diagrams[c].left+t.config.width/2+-1*T,t.diagrams[c].top),t.context.lineTo(t.diagrams[c].left+t.config.width/2+-1*T,t.diagrams[c].top-t.config.margin+T),t.context.lineTo(u.left+t.config.width/2+-1*T,u.top+t.config.height+t.config.margin+T),t.context.lineTo(u.left+t.config.width/2+-1*T,u.top+t.config.height+t.config.arrowWidth/2),t.context.lineWidth=t.config.lineWidth,t.context.stroke(),t.context.beginPath(),t.context.moveTo(u.left+t.config.width/2+-1*T,u.top+t.config.height),t.context.lineTo(u.left+t.config.width/2-t.config.arrowWidth/2+-1*T,u.top+t.config.height+t.config.arrowWidth),t.context.lineTo(u.left+t.config.width/2+t.config.arrowWidth/2+-1*T,u.top+t.config.height+t.config.arrowWidth),t.context.fill())}for(var c=0;c<t.diagrams.length;c++)if(!t.diagrams[c].orphan){var g=t.diagrams[c].left,f=t.diagrams[c].top;t.context.fillStyle=t.diagrams[c].bgColor,t.context.strokeStyle=t.diagrams[c].bgColor,t.helper.roundRect(t.context,g,f,t.config.width,t.config.height,t.config.radius,t.config.hiddenBg);var l=t.context;l.fillStyle=t.diagrams[c].color,l.font=t.config.fontSize+"px "+t.config.fontFamily,t.helper.wrapText(t.context,t.diagrams[c].text,g+t.config.padding,f,t.config.width-2*t.config.padding,t.config.height,t.config.fontSize+.2*t.config.fontSize)}};
